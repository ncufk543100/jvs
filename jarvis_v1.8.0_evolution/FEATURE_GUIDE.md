# JARVIS 功能详细说明 v3.0

> 一个有主权的本地 AI 代理人

## 🎯 核心理念

JARVIS 不是一个简单的自动化工具，而是一个**有主权的代理人**：
- 可以主动**拒绝执行**高风险操作
- 会根据你的**偏好**调整行为
- 给出**结论性判断**，而不只是技术分析
- **越用越懂你**

---

## 🏗️ 系统架构

### 核心模块

| 模块 | 文件 | 职责 |
|------|------|------|
| Agent 核心 | `agent.py` | 任务执行、计划生成、持续运行 |
| 主权判断 | `agent_sovereignty.py` | 评估操作风险、拒绝执行 |
| 结论输出 | `agent_conclusion.py` | 生成定性判断、专业分析 |
| 用户偏好 | `user_preferences.py` | 记住偏好、影响决策 |
| 长期记忆 | `long_term_memory.py` | 规则、知识、经验存储 |
| 任务报告 | `POST_RUN_REPORTER.py` | Manus 风格智能报告 |

### 工具模块

| 模块 | 文件 | 职责 |
|------|------|------|
| 执行器 | `executor.py` | 工具调度、参数解析 |
| 沙箱 | `sandbox.py` | 路径保护、安全执行 |
| 微信工具 | `wechat_devtools.py` | 开发者工具 CLI 集成 |
| LLM | `llm.py` | DeepSeek API 调用 |

---

## 🛡️ Agent 主权判断

### 核心能力

Agent 在执行任何操作前都会进行**主权判断**：

```
用户请求 → 快速评估 → 完整评估 → 判断结果
                ↓
        [拒绝/确认/继续]
```

### 判断类型

| 类型 | 说明 |
|------|------|
| `PROCEED` | 可以继续执行 |
| `REFUSE` | 拒绝执行 |
| `SUGGEST_ALTERNATIVE` | 建议替代方案 |
| `REQUEST_CONFIRMATION` | 需要用户确认 |
| `ESCALATE` | 升级给用户决定 |

### 绝对禁止的操作

以下操作会被**无条件拒绝**：

- 批量修改文件（`批量修改`、`批量替换`）
- `sed -i` 批量修改
- `find -exec` 批量操作
- `xargs` 批量操作
- `glob.glob` / `os.walk` 批量操作
- 循环批量修改文件

---

## 📋 结论性判断

### 从"分析"到"定性"

传统 AI 输出：
> "发现 config.py 第 15 行有一个变量未定义..."

JARVIS 输出：
> **这不是一个简单的变量错误，而是配置加载时序问题。**
>
> | 错误理解 | 正确理解 |
> |----------|----------|
> | 变量未定义 | 配置在模块加载前被访问 |

### 结论报告结构

1. **结论**：一句话定性判断
2. **核心原则**：错误理解 vs 正确理解
3. **修复方案**：Before → After
4. **影响评估**：范围和风险
5. **产品意义**：对用户体验的影响

---

## 👤 用户偏好系统

### 偏好类别

| 类别 | 偏好项 | 默认值 |
|------|--------|--------|
| 修复风格 | 偏好结构性修复 | 是 |
| 修复风格 | 避免热修复 | 否 |
| 确认要求 | UI 修改需确认 | 是 |
| 确认要求 | 删除需确认 | 是（强制） |
| 确认要求 | 禁止批量操作 | 是（强制） |
| 风险偏好 | 风险容忍度 | medium |

### 偏好学习

Agent 会从你的行为中学习偏好：

- 如果你多次拒绝热修复 → 学习到"避免热修复"
- 如果你经常要求详细解释 → 学习到"详细解释"
- 如果你偏好重构 → 学习到"偏好重构"

---

## 🔄 持续执行机制

### 不达目的不罢休

```
目标 → 方案1 → 失败 → 方案2 → 失败 → ... → 方案N → 成功
```

- 最多尝试 **5 种不同方案**
- 每个步骤最多重试 **3 次**
- 自动记录失败经验
- 只有成功或用户停止才结束

### 断点恢复

任务中断后可以恢复：
```python
from agent import resume_task
resume_task("task_id")
```

---

## 📱 微信开发者工具集成

### 可用功能

| 功能 | 说明 |
|------|------|
| `wechat_check_status` | 检查开发者工具状态 |
| `wechat_open_project` | 打开小程序项目 |
| `wechat_get_errors` | 获取编译错误 |
| `wechat_preview` | 预览小程序 |
| `wechat_upload` | 上传小程序 |
| `wechat_screenshot` | 截图 |

### 自动发现

Agent 会自动搜索微信开发者工具的安装路径，无需手动配置。

---

## 🔧 安全删除机制

### 删除流程

```
delete_file(path) → 加入待确认队列 → confirm_delete(path) → 真正删除
```

### 相关工具

| 工具 | 说明 |
|------|------|
| `delete_file` | 请求删除（加入队列） |
| `confirm_delete` | 确认删除 |
| `cancel_delete` | 取消删除 |
| `list_pending_deletes` | 查看待删除列表 |

---

## 🧠 长期记忆系统

### 记忆类型

| 类型 | 说明 | 文件 |
|------|------|------|
| 规则 | 行为规则 | `memory/rules/*.json` |
| 知识 | 项目知识 | `memory/knowledge/*.json` |
| 经验 | 成功/失败经验 | `memory/experiences/*.json` |
| 上下文 | 任务快照 | `memory/context/*.json` |

### 默认规则

- `delete_confirmation`: 删除文件必须确认
- `persistent_execution`: 持续执行直到目标达成

---

## 📡 API 接口

| 端点 | 方法 | 说明 |
|------|------|------|
| `/` | GET | Web UI |
| `/run` | POST | 执行任务 |
| `/events` | GET | 获取事件流 |
| `/health` | GET | 健康检查 |
| `/report` | GET | 获取最新报告 |
| `/pending-deletes` | GET | 待删除文件列表 |

---

## 🚀 快速开始

```bash
# 安装依赖
pip install -r requirements.txt

# 配置 API 密钥
export DEEPSEEK_API_KEY="your-api-key"

# 启动服务
uvicorn server:app --host 0.0.0.0 --port 8000

# 访问 Web UI
open http://localhost:8000
```

---

## 📝 版本历史

- **v3.0**: Agent 主权判断、结论性输出、用户偏好系统
- **v2.0**: 持续执行、长期记忆、微信工具集成
- **v1.0**: 基础功能
